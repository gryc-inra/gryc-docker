# HTTP/1.1 connexion (redirect on https)
server {
    listen      80;
    server_name gryc.dev;

    # Redirect the previous URL to the new one
    location = /index.php {
        # Redirect download
        if ($args ~ "/?page=download$") {
            return 302 https://$host/strain;
        }

        # Redirect blast
        if ($args ~ "/?page=blast$") {
            return 302 https://$host/blast;
        }

        # Redirect search
        if ($args ~ "/?page=search$") {
            return 302 https://$host/advanced-search;
        }
    }

    location / {
        # Redirect the http flux to https (301: Permanent redirection)
        return 301 https://$host$request_uri;
    }
}

# HTTP/2 or HTTP/1.1 over SSL connexion
server {
    listen      443 ssl http2;
    server_name gryc.dev;

    # SSL configuration
    ssl_certificate     /etc/nginx/ssl/gryc.crt;
    ssl_certificate_key /etc/nginx/ssl/gryc.key;

    # SSL optimizations

    # Session Caching
    ssl_session_cache shared:SSL:20m;
    ssl_session_timeout 4h;

    # Session Tickets and IDs
    ssl_session_tickets on;

    # Secure
    # The page cannot be displayed in a frame
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Frame-Options DENY;

    # Block WordPress Pingback DDoS attacks
    if ($http_user_agent ~* "WordPress") {
      return 403;
    }

    location / {
        # Test exixtance of a page, if exist: return 503 error
        if (-f /home/mpiot/Development/gryc-docker/maintenance-on.html) {
            return 503;
        }

        # Set the reverse proxy, to redirect http request to the Docker server
        proxy_pass          http://127.0.0.1:8080;
    }

    # Set the 503 code: Service Unavailable (Service temporarily unavailable or in maintenance.)
    error_page 503 @maintenance;
    location @maintenance {
        root    /home/mpiot/Development/gryc-docker;
        rewrite ^(.*)$ /maintenance-on.html break;
    }
}

